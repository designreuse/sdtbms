package com.bus.stripes.actionbean;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.util.Date;

import org.apache.commons.io.FileUtils;

import com.bus.services.HRBean;
import com.bus.util.ExcelFileWriter;

import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.HandlesEvent;
import net.sourceforge.stripes.action.RedirectResolution;
import net.sourceforge.stripes.action.Resolution;
import net.sourceforge.stripes.action.StreamingResolution;
import net.sourceforge.stripes.action.UrlBinding;
import net.sourceforge.stripes.integration.spring.SpringBean;

@UrlBinding("/actionbean/Filedownload.action")
public class FiledownloadActionBean implements ActionBean{

	private MyActionBeanContext context;
	public MyActionBeanContext getContext() { return context; }
	public void setContext(ActionBeanContext context) { this.context = (MyActionBeanContext)context; }
	
	public HRBean getBean() {
		return bean;
	}
	@SpringBean
	public void setBean(HRBean bean) {
		this.bean = bean;
	}

	private HRBean bean;
	
	
	@DefaultHandler
	public Resolution defaultAction(){
		return new StreamingResolution("text/html","没有文件可供下载");
	}
	
	@HandlesEvent(value="employees")
	public Resolution downloadEmployee(){
		try {
//			File directory = (File)context.getServletContext().getAttribute("javax.servlet.context.tmpdir");
//			File file = File.createTempFile("employees", ".csv", directory);
//			FileWriter out = new FileWriter(file);
			
			ExcelFileWriter writer = new ExcelFileWriter();
			String content = writer.writeEmployees(bean,"A");
			
			StreamingResolution sr = new StreamingResolution("text/csv",content);
			sr.setAttachment(true);
			sr.setCharacterEncoding("UTF-8");
			sr.setFilename("employees.csv");
			return sr;
		} catch (IOException e) {
			e.printStackTrace();
			return new StreamingResolution("text/html","下载失败，请联系管理员"+new Date());
		}
	}
	
}
